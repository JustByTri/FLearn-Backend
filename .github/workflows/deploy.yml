name: Deploy FLearn Backend

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy via Direct SSH
      run: |
        # Install SSH client
        sudo apt-get update
        sudo apt-get install -y openssh-client
        
        # Setup SSH key
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Add server to known hosts
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
        
        # Execute deployment commands
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          echo "ðŸš€ Direct SSH Deployment - No Docker!"
          echo "Time: $(date)"
          
          # Stop service
          systemctl stop flearn-backend
          
          # Update code
          cd /root/FLearn-Backend
          git pull origin main
          
          # Build and publish
          cd Presentation
          dotnet restore --verbosity minimal
          dotnet publish -c Release -o /var/www/flearn-backend-published --verbosity minimal
          
          # Set permissions
          chown -R www-data:www-data /var/www/flearn-backend-published
          chmod +x /var/www/flearn-backend-published/Presentation.dll
          
          # Start service
          systemctl start flearn-backend
          sleep 10
          
          # Check status
          systemctl status flearn-backend --no-pager
          
          echo "âœ… Deployment completed!"
        EOF
