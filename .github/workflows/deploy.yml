name: Deploy FLearn Backend (Stable)

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: flearn-backend-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Prepare SSH client
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts
          {
            echo "Host *"
            echo "  ServerAliveInterval 25"
            echo "  ServerAliveCountMax 4"
          } >> ~/.ssh/config

      - name: Deploy (Build on server)
        run: |
          set -euo pipefail
          echo "==> Connecting to server..."
          ssh -o StrictHostKeyChecking=yes "${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}" 'bash -seu' <<'EOF'
            set -euo pipefail
            SERVICE_NAME="flearn-backend"
            REPO_DIR="/root/FLearn-Backend"
            PUBLISH_DIR="/var/www/flearn-backend-published"
            
            banner() { printf "\n===== %s =====\n" "$1"; }

            banner "Environment Info"
            echo "TIME: $(date -u)"
            echo "USER: $(whoami)"
            echo "PWD:  $(pwd)"
            dotnet --info | head -n 20 || echo ".NET info unavailable"

            banner "Forcefully stopping service and waiting for it to terminate"
            if systemctl is-active --quiet "$SERVICE_NAME"; then
              systemctl kill "$SERVICE_NAME"
              echo "Kill command sent. Pausing for 2 seconds before checking..."
              sleep 2
              
              echo "Waiting for service to terminate..."
              for i in {1..10}; do
                if ! systemctl is-active --quiet "$SERVICE_NAME"; then
                  echo "Service has terminated."
                  break
                fi
                if [ $i -eq 10 ]; then
                  echo "ERROR: Service did not terminate after ~50 seconds."
                  exit 1
                fi
                sleep 5
              done
            else
              echo "Service is not running. Nothing to stop."
            fi

            banner "Updating repository"
            if [ ! -d "$REPO_DIR/.git" ]; then
              echo "Repository folder missing: $REPO_DIR"
              exit 1
            fi
            cd "$REPO_DIR"
            git fetch --all --prune
            git reset --hard origin/main
            git clean -fdx

            banner "Building & Publishing"
            cd Presentation
            dotnet publish -c Release -o "$PUBLISH_DIR" --verbosity minimal

            banner "Setting permissions"
            chown -R www-data:www-data "$PUBLISH_DIR"

            banner "Starting service"
            systemctl start "$SERVICE_NAME"
            
            banner "Waiting for service to become active"
            for i in {1..12}; do
              if systemctl is-active --quiet "$SERVICE_NAME"; then
                echo "Service is active."
                break
              fi
              echo "[$i] Waiting 5s..."
              sleep 5
            done

            if ! systemctl is-active --quiet "$SERVICE_NAME"; then
              echo "ERROR: Service failed to become active."
              journalctl -u "$SERVICE_NAME" -n 120 --no-pager || true
              exit 1
            fi

            banner "Last 40 log lines"
            journalctl -u "$SERVICE_NAME" -n 40 --no-pager || true
            echo "âœ… Deployment completed successfully at $(date -u)"
          EOF
          
      - name: Done
        run: echo "ðŸŽ‰ Deployment job finished."
