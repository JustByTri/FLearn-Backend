name: Deploy FLearn Backend (Stable)
on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: flearn-backend-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Prepare SSH client
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts
          {
            echo "Host *"
            echo "  ServerAliveInterval 25"
            echo "  ServerAliveCountMax 4"
          } >> ~/.ssh/config

      - name: Deploy (Build on server)
        run: |
          set -euo pipefail
          echo "==> Connecting to server..."
          ssh -o StrictHostKeyChecking=yes "${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}" 'bash -seu' <<'EOF'
            set -euo pipefail
            SERVICE_NAME="flearn-backend"
            REPO_DIR="/root/FLearn-Backend"
            PUBLISH_DIR="/var/www/flearn-backend-published"
           
            banner() { printf "\n===== %s =====\n" "$1"; }
            
            banner "Environment Info"
            echo "TIME: $(date -u)"
            echo "USER: $(whoami)"
            echo "PWD:  $(pwd)"
            dotnet --info | head -n 20 || echo ".NET info unavailable"
            
            banner "Step 1: Stop service and release file locks"
            if systemctl is-active --quiet "$SERVICE_NAME"; then
              echo "Stopping service..."
              systemctl stop "$SERVICE_NAME"
              sleep 2
            fi
            
            echo "Killing any remaining dotnet processes..."
            pkill -9 -f "Presentation.dll" || true
            pkill -9 -f "dotnet" || true
            sleep 3
            
            echo "Verifying service is stopped..."
            for i in {1..5}; do
              if ! systemctl is-active --quiet "$SERVICE_NAME"; then
                echo "âœ“ Service confirmed stopped"
                break
              fi
              echo "[$i] Waiting for service to stop..."
              sleep 2
            done
            
            banner "Step 2: Clean old publish directory"
            if [ -d "$PUBLISH_DIR" ]; then
              echo "Removing old publish directory..."
              rm -rf "$PUBLISH_DIR"
              sleep 1
            fi
            mkdir -p "$PUBLISH_DIR"
            echo "âœ“ Publish directory ready"
            
            banner "Step 3: Update repository"
            if [ ! -d "$REPO_DIR/.git" ]; then
              echo "ERROR: Repository folder missing: $REPO_DIR"
              exit 1
            fi
            cd "$REPO_DIR"
            git fetch --all --prune
            git reset --hard origin/main
            git clean -fdx
            echo "âœ“ Repository updated"
            
            banner "Step 4: Build & Publish Release"
            cd Presentation
            dotnet publish -c Release -o "$PUBLISH_DIR" \
              -p:DebugType=none \
              -p:DebugSymbols=false \
              --verbosity minimal 2>&1 | grep -E "(error|warning|Build|Publish)" || true
            
            if [ ! -f "$PUBLISH_DIR/Presentation.dll" ]; then
              echo "ERROR: Presentation.dll not found after publish!"
              exit 1
            fi
            echo "âœ“ Build completed successfully"
            
            banner "Step 5: Set permissions"
            chown -R www-data:www-data "$PUBLISH_DIR"
            chmod -R 755 "$PUBLISH_DIR"
            echo "âœ“ Permissions set"
            
            banner "Step 6: Start service"
            systemctl start "$SERVICE_NAME"
            sleep 2
            
            banner "Step 7: Verify service is running"
            for i in {1..12}; do
              if systemctl is-active --quiet "$SERVICE_NAME"; then
                echo "âœ“ Service is active and running"
                break
              fi
              if [ $i -eq 12 ]; then
                echo "ERROR: Service failed to start!"
                echo ""
                echo "Recent logs:"
                journalctl -u "$SERVICE_NAME" -n 50 --no-pager || true
                exit 1
              fi
              echo "[$i/12] Waiting for service to start..."
              sleep 5
            done
            
            banner "Step 8: Service Status & Logs"
            systemctl status "$SERVICE_NAME" --no-pager
            echo ""
            echo "Last 30 log lines:"
            journalctl -u "$SERVICE_NAME" -n 30 --no-pager || true
            
            banner "âœ… Deployment completed successfully"
            echo "TIME: $(date -u)"
            echo "Service: $SERVICE_NAME"
            echo "Status: $(systemctl is-active $SERVICE_NAME)"
          EOF
         
      - name: Done
        run: echo "ðŸŽ‰ Deployment job finished successfully!"


## ðŸš€ Copy toÃ n bá»™ file nÃ y vÃ o:
```
.github/workflows/deploy.yml
